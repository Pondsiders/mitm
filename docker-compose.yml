services:
  mitmproxy:
    build: .
    container_name: alpha-mitm
    restart: unless-stopped
    ports:
      - "8080:8080"      # Proxy port
      - "8081:8081"      # Web interface (optional)
    volumes:
      - ./addons:/addons:ro
      - ./data:/data
      - mitm-certs:/home/mitmproxy/.mitmproxy
    environment:
      - MITM_DATA_DIR=/data
      - SCRIBE_DB_URL=postgresql://scribe:scribe@172.17.0.1:5725/scribe
    command: >
      mitmdump
      --mode reverse:https://api.anthropic.com
      --set confdir=/home/mitmproxy/.mitmproxy
      --listen-host 0.0.0.0
      --listen-port 8080
      --scripts /addons/quota_logger.py
      --scripts /addons/scribe_logger.py

  dashboard:
    image: python:3.12-slim
    container_name: alpha-dashboard
    restart: unless-stopped
    ports:
      - "8501:8501"
    volumes:
      - ./dashboard:/app:ro
      - ./data:/data:ro
    working_dir: /app
    command: >
      bash -c "pip install -q streamlit pandas &&
      streamlit run app.py --server.address 0.0.0.0 --server.port 8501 --server.headless true"

volumes:
  mitm-certs:
    # Persists the CA certificate so we don't regenerate it each time
